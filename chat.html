<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
<title>Ai ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ</title>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet" />
<style>
/* ===================== THEME ===================== */
:root{
  --primary:#403aed; --primary-2:#5830f6; --primary-3:#5b21b6;
  --ok:#f1df15; --warn:#510bf5; --danger:#e9f416;
  --bg:#0b1020; --bg-2:#0f1530; --panel:#0f1430cc;
  --surface:#11183a; --surface-2:#0f1534; --chip:#1a2150;
  --text:#e9eef9; --muted:#a9b2c7; --light:#f8fafc; --gray:#64748b; --gray-2:#e2e8f0;
  --glass: rgba(255,255,255,.07);
  --line: rgba(255,255,255,.14);
}
*{box-sizing:border-box}
html,body{height:100%}
body{
  margin:0; color:var(--text);
  background:
    radial-gradient(1200px 700px at 120% -10%, #2a1f63 0%, transparent 60%),
    radial-gradient(1000px 600px at -10% 10%, #fffc43 0%, transparent 55%),
    linear-gradient(135deg, #0b1020 0%, #051a83 40%, #766f10 100%);
  min-height:100dvh; overflow-x:hidden;
  font-family: system-ui,-apple-system,"Segoe UI",Inter,Roboto,"Noto Sans Thai",sans-serif;
}
.app{display:flex;flex-direction:column;width:100%;max-width:1200px;margin-inline:auto;height:calc(var(--vh,1vh)*100);container-type:inline-size;position:relative}

/* ===================== TOPBAR ===================== */
.topbar{
  height:56px; display:flex; align-items:center; gap:12px; padding:0 14px;
  position:sticky; top:0; z-index:30;
  background:linear-gradient(to right,rgb(45, 66, 223),#f0f333);
  border-bottom:1px solid #ffffff14; backdrop-filter:blur(10px);
}
.hamburger{
  width:40px;height:40px;border-radius:10px;border:1px solid #ffffff1a;background:#ffffff10;color:#fff;
  display:grid;place-items:center;cursor:pointer;transition:transform .08s ease, box-shadow .2s ease;
}
.hamburger:hover{box-shadow:0 6px 14px #0006}
.hamburger:active{transform:scale(.96)}
.brand{display:flex;align-items:center;gap:12px;min-width:0}
.logo{
  width:36px;height:36px;border-radius:50%;
  color:#fff; font-weight:800; display:grid; place-items:center; box-shadow:0 6px 16px #7c3aed55;
  overflow:hidden; border:1px solid #ffffff22; background:#0000;
}
.logo img{width:36px;height:36px;object-fit:cover;display:block;border-radius:50%}
.titlestack h1{font-size:16px;margin:0;line-height:1.1;letter-spacing:.2px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.titlestack p{margin:2px 0 0;font-size:12px;color:#dbe3ffcc}

/* ===================== CHAT ===================== */
.chat{flex:1 1 auto;display:flex;flex-direction:column;overflow:hidden;position:relative}
.messages{
  flex:1;overflow-y:auto;padding:18px;
  background:linear-gradient(180deg,#0e1330 0%,#0b1028 100%);
  scroll-behavior:smooth;
}
.msg{display:flex;gap:12px;margin:10px 0;max-width:900px;animation:msgIn .25s cubic-bezier(.21,.58,.24,.99)}
.msg.user{flex-direction:row-reverse;margin-left:auto}
@keyframes msgIn{from{opacity:0;transform:translateY(8px) scale(.98)}to{opacity:1;transform:none}}

.avatar{
  width:40px;height:40px;border-radius:50%;display:grid;place-items:center;flex-shrink:0;color:#fff;
  overflow:hidden; border:1px solid #ffffff1f; background:#0e153a;
}
.avatar img{width:100%;height:100%;object-fit:cover;display:block}
.avatar.user{background:linear-gradient(135deg,var(--primary),var(--primary-2))}
.bubble{
  position:relative;
  padding:14px 16px;border-radius:18px;line-height:1.55;box-shadow:0 6px 18px #00000030;border:1px solid #ffffff14;
  max-width:min(78cqw,780px);white-space:pre-wrap;word-wrap:break-word;
  transform-origin:var(--origin, left);
}
.msg.user .bubble{
  --origin:right;
  background:linear-gradient(135deg,var(--primary),var(--primary-2));color:#fff;border-bottom-right-radius:6px;
  animation:pop .2s ease;
}
.msg.ai .bubble{
  background:linear-gradient(180deg,#0f153a 0%, #0c1334 100%); color:#e9eef9; border-bottom-left-radius:6px;
}
@keyframes pop{from{transform:scale(.98)}to{transform:scale(1)}}
.time{font-size:12px;opacity:.7;margin-top:6px}
.typing{
  display:none;gap:8px;align-items:center;width:max-content;background:#0f153a;border:1px solid #ffffff1a;border-radius:14px;
  padding:10px 12px;margin:8px 0; box-shadow:0 6px 14px #00000025;
}
.typing .dot3{width:8px;height:8px;border-radius:50%;background:#9fb2ff;opacity:.6;animation:typing 1.2s infinite ease-in-out}
.typing .dot3:nth-child(2){animation-delay:.15s}
.typing .dot3:nth-child(3){animation-delay:.3s}
@keyframes typing{0%,80%,100%{transform:translateY(0);opacity:.45}40%{transform:translateY(-4px);opacity:1}}

.composer{
  flex:0 0 auto;padding:10px 12px;background:#0b1020cc;border-top:1px solid #ffffff14;backdrop-filter:blur(10px);
  position:sticky;bottom:0;z-index:20;
  padding-bottom: calc(10px + env(safe-area-inset-bottom));
}
.row{display:flex;gap:10px;align-items:center}
.input{
  flex:1;background:#0f1534;border:1px solid #ffffff1a;color:var(--text);padding:14px 16px;border-radius:999px;outline:none;font-size:15px;
  transition:box-shadow .2s, border-color .2s, transform .06s;
}
.input:focus{box-shadow:0 0 0 4px #7c3aed33;border-color:#7c3aed66}
.send{
  background:linear-gradient(135deg,var(--primary-2),var(--primary));border:none;color:#fff;border-radius:999px;padding:12px 18px;font-weight:700;
  cursor:pointer;display:flex;align-items:center;gap:8px;box-shadow:0 10px 24px #7c3aed44;transition:transform .08s ease, box-shadow .2s ease;
}
.send:hover{box-shadow:0 14px 30px #7c3aed55}
.send:active{transform:translateY(1px) scale(.99)}
.chips{display:flex;flex-wrap:wrap;gap:8px;margin:10px 0 4px}
.chip{
  border:1px solid #ffffff1a;background:#ffffff10;color:#dfe7ff;padding:8px 12px;border-radius:999px;font-size:13px;cursor:pointer;
  transition:transform .06s ease, background .15s ease, border-color .15s ease;
}
.chip:hover{background:#ffffff1f;border-color:#ffffff30}
.chip:active{transform:translateY(1px)}

/* ===================== DRAWER ===================== */
.overlay{position:fixed;inset:0;background:#0008;opacity:0;pointer-events:none;transition:.15s;z-index:60}
.overlay.show{opacity:1;pointer-events:auto}
.drawer{
  position:fixed;inset:0 auto 0 0;width:min(86vw,320px);background:#0c1230;border-right:1px solid #ffffff1a;
  transform:translateX(-100%);transition:transform .2s ease;z-index:70;display:flex;flex-direction:column
}
.drawer.open{transform:none}
.drawer .dhead{display:flex;align-items:center;gap:10px;padding:14px;border-bottom:1px solid #ffffff12;background:linear-gradient(90deg,#231c5a,#1a2a6a)}
.drawer .dlogo{width:36px;height:36px;border-radius:50%;background:#fff;color:var(--primary);display:grid;place-items:center;font-weight:800}
.drawer .dtitle{font-weight:700}
.dlist{padding:8px 10px}
.ditem{
  display:flex;align-items:center;gap:12px;padding:12px 10px;border-radius:12px;cursor:pointer;color:#e9eef9;border:1px solid transparent;text-decoration:none;
  transition:background .15s ease, border-color .15s ease
}
.ditem:hover{background:#ffffff10;border-color:#ffffff1a}
.ditem i{width:22px;text-align:center}

/* ===================== ANIMATED ORBS (background spice) ===================== */
.orb{
  position:fixed; border-radius:50%; filter:blur(40px); opacity:.18; pointer-events:none; z-index:0;
  animation: drift var(--dur,14s) ease-in-out infinite alternate;
}
.orb.o1{width:320px;height:320px;background:#7c3aed; top:12%; left:8%; --dur:16s}
.orb.o2{width:260px;height:260px;background:#22c55e; bottom:8%; right:10%; --dur:18s}
.orb.o3{width:220px;height:220px;background:#38bdf8; bottom:22%; left:18%; --dur:14s}
@keyframes drift{from{transform:translate3d(0,0,0)}to{transform:translate3d(18px,-22px,0)}}

/* ===================== RESPONSIVE ===================== */
@media (max-width:768px){
  .topbar{height:54px}
  .titlestack h1{font-size:15px}
  .messages{padding:12px}
  .bubble{max-width:100%}
  .send span{display:none}
}
@media (max-width:360px){ .brand .logo{display:none} }

/* ===================== ACCESSIBILITY ===================== */
@media (prefers-reduced-motion: reduce){
  .msg, .send, .chip, .typing .dot3, .orb{animation:none !important}
  .input, .send{transition:none}
}

/* Small helper labels under composer */
.meta-row{
  display:flex; gap:10px; align-items:center; padding:6px 4px 0 4px; font-size:12px; opacity:.9;
}
.badge{ margin-left:auto; background:#ffffff14; border:1px solid #ffffff1a; padding:4px 10px; border-radius:999px; }
</style>
</head>
<body>
  <!-- Animated soft orbs -->
  <div class="orb o1"></div><div class="orb o2"></div><div class="orb o3"></div>

  <div class="app">
    <header class="topbar">
      <button class="hamburger" id="btnMenu" aria-label="‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏°‡∏ô‡∏π"><i class="fa-solid fa-bars"></i></button>

      <div class="brand">
        <div class="logo">
          <a href="#" class="logo-link" aria-label="‡πÇ‡∏•‡πÇ‡∏Å‡πâ">
            <!-- ‡∏£‡∏π‡∏õ‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÉ‡∏™‡πà‡∏ú‡πà‡∏≤‡∏ô JS ‡∏à‡∏≤‡∏Å LOGO_URL -->
            <img id="logoImg" alt="Logo" width="36" height="36" loading="lazy" decoding="async" referrerpolicy="no-referrer" />
          </a>
        </div>
        <div class="titlestack">
          <h1 id="titleText">Ai ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ Chat</h1>
          <p id="subtitle">Powered by ‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ</p>
        </div>
      </div>
    </header>

    <div class="overlay" id="overlay"></div>
    <aside class="drawer" id="drawer" aria-hidden="true">
      <div class="dhead">
        <div class="dlogo">DS</div>
        <div><div class="dtitle">‡πÄ‡∏°‡∏ô‡∏π</div><small style="opacity:.8">Ai ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ</small></div>
      </div>
      <nav class="dlist">
        <a class="ditem" href="http://192.168.2.57:5000/"><i class="fa-solid fa-microphone-lines"></i> ‡∏™‡∏•‡∏±‡∏ö ‡πÅ‡∏ä‡∏ó‡∏î‡πâ‡∏ß‡∏¢‡πÄ‡∏™‡∏µ‡∏¢‡∏á</a>
      </nav>
    </aside>

    <main class="chat">
      <div class="messages" id="messages">
        <!-- ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏ô‡∏£‡∏±‡∏ö‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô (‡πÉ‡∏ä‡πâ‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏£‡∏π‡∏õ‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå AI) -->
        <div class="msg ai">
          <div class="avatar ai"><img id="aiAvatarInitial" alt="AI Avatar"/></div>
          <div class="bubble">
‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞! ‡∏â‡∏±‡∏ô‡∏Ñ‡∏∑‡∏≠ ‡∏û‡∏≠‡πÉ‡∏à ‡∏°‡∏µ‡∏≠‡∏∞‡πÑ‡∏£‡πÉ‡∏´‡πâ‡∏ä‡πà‡∏ß‡∏¢‡∏°‡∏±‡πâ‡∏¢‡∏Ñ‡∏∞! üëã
<br/>‡∏•‡∏≠‡∏á‡∏Å‡∏î‡∏õ‡∏∏‡πà‡∏°‡∏•‡∏±‡∏î‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏´‡∏£‡∏∑‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ñ‡∏≥‡∏ñ‡∏≤‡∏°‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏¢
<div class="chips" id="chips-initial">
  <button class="chip" data-q="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Ai ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ">‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö Ai ‡πÄ‡∏õ‡∏¥‡∏î‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô‡∏ö‡∏∏‡∏£‡∏µ</button>
  <button class="chip" data-q="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö ‡∏Ñ‡∏ì‡∏∞‡∏ú‡πâ‡∏π‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô">‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö ‡∏Ñ‡∏ì‡∏∞‡∏ú‡πâ‡∏π‡∏ö‡∏£‡∏¥‡∏´‡∏≤‡∏£‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô</button>
  <button class="chip" data-q="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏£‡∏∞‡∏¢‡∏∞‡∏™‡∏±‡πâ‡∏ô">‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö ‡∏´‡∏•‡∏±‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏£‡∏∞‡∏¢‡∏∞‡∏™‡∏±‡πâ‡∏ô</button>
  <button class="chip" data-q="‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô">‡πÄ‡∏Å‡∏µ‡πà‡∏¢‡∏ß‡∏Å‡∏±‡∏ö ‡∏™‡∏≤‡∏Ç‡∏≤‡∏ß‡∏¥‡∏ä‡∏≤‡∏Å‡∏≤‡∏£‡∏≠‡∏≤‡∏ä‡∏µ‡∏û‡∏õ‡∏£‡∏≤‡∏à‡∏µ‡∏ô</button>
</div>
<div class="time">‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ</div>
          </div>
        </div>
        <div class="typing" id="typing"><span class="dot3"></span><span class="dot3"></span><span class="dot3"></span></div>
      </div>

      <div class="composer">
        <div class="row">
          <input id="input" class="input" type="text" placeholder="‡∏û‡∏¥‡∏°‡∏û‡πå‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà‚Ä¶ (Shift+Enter = ‡∏Ç‡∏∂‡πâ‡∏ô‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡πÉ‡∏´‡∏°‡πà)" autocomplete="off" />
          <button id="send" class="send"><i class="fa-solid fa-paper-plane"></i><span> ‡∏™‡πà‡∏á</span></button>
        </div>
        <div class="meta-row">
          <label style="display:flex; gap:6px; align-items:center; cursor:pointer;">
            <input type="checkbox" id="streamToggle" />
            ‡∏™‡∏ï‡∏£‡∏µ‡∏°‡∏Ñ‡∏≥‡∏ï‡∏≠‡∏ö (‡πÄ‡∏£‡πá‡∏ß ‡∏•‡∏∑‡πà‡∏ô)
          </label>
          <!-- <span id="modelBadge" class="badge">model: <b>gemma3:4b</b></span> -->
        </div>
      </div>
    </main>
  </div>

<script>
/* ====== CONFIG (‡πÑ‡∏°‡πà‡πÅ‡∏ï‡∏∞ endpoint ‡πÄ‡∏î‡∏¥‡∏°) ====== */
const API_BASE = window.location.origin;
const GENERATE_ENDPOINT = `${API_BASE}/api/generate`;
const TAGS_ENDPOINT     = `${API_BASE}/api/tags`;
let CURRENT_MODEL = "gemma3:4b";

/* ‚úÖ ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏Å‡∏±‡∏ö‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡∏ó‡∏∏‡∏Å‡∏ó‡∏µ‡πà (‡∏ï‡∏±‡πâ‡∏á‡∏ï‡∏£‡∏á‡∏ô‡∏µ‡πâ‡∏ó‡∏µ‡πà‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡∏û‡∏≠) */
const LOGO_URL = "https://img2.pic.in.th/pic/imge235379524201c94e1.png";

/* ====== View helpers ====== */
function setVH(){ document.documentElement.style.setProperty('--vh', `${window.innerHeight*0.01}px`); }
setVH(); addEventListener('resize', setVH);

const el = {
  messages: document.getElementById('messages'),
  input: document.getElementById('input'),
  send: document.getElementById('send'),
  typing: document.getElementById('typing'),
  btnMenu: document.getElementById('btnMenu'),
  drawer: document.getElementById('drawer'),
  overlay: document.getElementById('overlay'),
  streamToggle: document.getElementById('streamToggle'),
  logoImg: document.getElementById('logoImg'),
  aiAvatarInitial: document.getElementById('aiAvatarInitial'),
};

function openDrawer(){ el.drawer?.classList.add('open'); el.overlay?.classList.add('show'); el.drawer?.setAttribute('aria-hidden','false'); }
function closeDrawer(){ el.drawer?.classList.remove('open'); el.overlay?.classList.remove('show'); el.drawer?.setAttribute('aria-hidden','true'); }
el.btnMenu?.addEventListener('click', openDrawer);
el.overlay?.addEventListener('click', closeDrawer);

const timeNow = () => new Date().toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
function scrollToBottom(){ if(el.messages) el.messages.scrollTop = el.messages.scrollHeight; }

/* ‚úÖ ‡∏Ñ‡∏∑‡∏ô HTML avatar ‡∏ï‡∏≤‡∏°‡∏ù‡∏±‡πà‡∏á‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ/AI
   - ‡∏ù‡∏±‡πà‡∏á AI ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ LOGO_URL
   - ‡∏ù‡∏±‡πà‡∏á USER ‡πÉ‡∏ä‡πâ‡πÑ‡∏≠‡∏Ñ‡∏≠‡∏ô‡∏¢‡∏π‡∏™‡πÄ‡∏ã‡∏≠‡∏£‡πå‡∏õ‡∏Å‡∏ï‡∏¥ (‡πÑ‡∏°‡πà‡∏¢‡∏∏‡πà‡∏á‡∏£‡∏∞‡∏ö‡∏ö) */
function avatarHTML(who="ai"){
  if(who === "user"){
    return `<div class="avatar user"><i class="fa-solid fa-user"></i></div>`;
  }
  return `<div class="avatar ai"><img src="${LOGO_URL}" alt="AI Avatar"/></div>`;
}

function addMsg(text, who="ai"){
  const wrap = document.createElement('div');
  wrap.className = `msg ${who==='user'?'user':'ai'}`;
  wrap.innerHTML = `
    ${avatarHTML(who)}
    <div class="bubble">${escapeHTML(text)}<div class="time">${timeNow()}</div></div>
  `;
  el.messages.appendChild(wrap);
  scrollToBottom();
  return {wrap, bubble: wrap.querySelector('.bubble')};
}

/* ‡∏õ‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ô XSS ‡πÄ‡∏•‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢ */
function escapeHTML(s){ return s.replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }

/* ====== Status / Models (‡πÄ‡∏ä‡πá‡∏Ñ‡∏Å‡∏≤‡∏£‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÄ‡∏â‡∏¢ ‡πÜ) ====== */
async function quickPing(){
  try{
    const ctrl = new AbortController(); const id = setTimeout(()=>ctrl.abort(), 2500);
    const res = await fetch(TAGS_ENDPOINT, {signal: ctrl.signal}); clearTimeout(id);
    if(!res.ok) throw 0;
    await res.json();
    return true;
  }catch{ return false; }
}
quickPing(); setInterval(quickPing, 10000);

/* ====== ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏õ backend ‡πÄ‡∏î‡∏¥‡∏° ====== */
function setTyping(v){ if(!el.typing) return; el.typing.style.display = v?'flex':'none'; scrollToBottom(); }

async function askOllama(prompt, {stream=false}={}){
  const body = JSON.stringify({ model: CURRENT_MODEL, prompt, stream });
  if(!stream){
    setTyping(true);
    try{
      const res = await fetch(GENERATE_ENDPOINT, { method:'POST', headers:{'Content-Type':'application/json'}, body });
      if(!res.ok) throw 0;
      const data = await res.json();
      return data.response || "(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö)";
    }catch{
      return "‚ö†Ô∏è ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ: ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Flask ‡πÅ‡∏•‡∏∞ OLLAMA_BASE";
    }finally{ setTyping(false); }
  }

  // stream=true : ‡πÄ‡∏ï‡∏¥‡∏°‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏µ‡∏•‡∏∞‡∏ä‡∏¥‡πâ‡∏ô
  setTyping(true);
  let full = "";
  const {bubble} = addMsg("", "ai"); // placeholder ‡∏ó‡∏µ‡πà‡∏°‡∏µ avatar ‡πÄ‡∏õ‡πá‡∏ô‡πÇ‡∏•‡πÇ‡∏Å‡πâ‡πÅ‡∏•‡πâ‡∏ß
  try{
    const resp = await fetch(GENERATE_ENDPOINT, { method:'POST', headers:{'Content-Type':'application/json'}, body });
    if(!resp.ok){ bubble.firstChild.nodeValue = "‚ö†Ô∏è ‡∏™‡∏ï‡∏£‡∏µ‡∏°‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß"; setTyping(false); return ""; }
    const reader = resp.body.getReader();
    const decoder = new TextDecoder();
    while(true){
      const {done, value} = await reader.read();
      if(done) break;
      full += decoder.decode(value, {stream:true});
      bubble.firstChild.nodeValue = full;
      scrollToBottom();
    }
  }catch{ bubble.firstChild.nodeValue = full || "‚ö†Ô∏è ‡∏´‡∏•‡∏∏‡∏î‡∏£‡∏∞‡∏´‡∏ß‡πà‡∏≤‡∏á‡∏™‡∏ï‡∏£‡∏µ‡∏°"; }
  finally{
    setTyping(false);
    const t = bubble.querySelector('.time'); if(t) t.textContent = timeNow();
  }
  return full;
}

async function sendMessage(){
  const text = el.input.value;
  const trimmed = text.replace(/\r?\n/g, '\n').trim();
  if(!trimmed) return;
  el.input.value = '';
  addMsg(trimmed, 'user');

  const useStream = el.streamToggle?.checked;
  if(useStream){ await askOllama(trimmed, {stream:true}); }
  else{ const reply = await askOllama(trimmed, {stream:false}); addMsg(reply, 'ai'); }
}

/* ====== Init ====== */
(function initBrandAndAvatar(){
  if(el.logoImg) el.logoImg.src = LOGO_URL;
  if(el.aiAvatarInitial) el.aiAvatarInitial.src = LOGO_URL;
})();

el.send?.addEventListener('click', sendMessage);
el.input?.addEventListener('keydown', (e)=>{
  if(e.key === 'Enter'){
    if(e.shiftKey) return;
    e.preventDefault(); sendMessage();
  }
});

/* Quick chips */
document.getElementById('chips-initial')?.addEventListener('click', async (e)=>{
  const b = e.target.closest('button[data-q]'); if(!b) return;
  addMsg(b.dataset.q, 'user');
  const useStream = el.streamToggle?.checked;
  if(useStream){ await askOllama(b.dataset.q, {stream:true}); }
  else{ const r = await askOllama(b.dataset.q, {stream:false}); addMsg(r, 'ai'); }
});
</script>
</body>
</html>